<!--
Profit Pulse — SEO-ready PWA (index.html + sw.js + manifest.json)

Files included below. Save as separate files as noted:
  1) index.html  (HTML portion below)
  2) sw.js       (Service Worker - copy into sw.js)
  3) manifest.json (copy into manifest.json)

This revision fixes a runtime error where event listeners were being attached before the DOM was ready ("Cannot read properties of null (reading 'addEventListener')"). All DOM access and event listener registration now happen inside DOMContentLoaded. Additional safety checks guard against missing elements.

Features:
- SEO-ready meta + JSON-LD
- Progressive Web App (installable)
- Day & Night themes
- Offline mode (service worker + localStorage)
- Interactive Profit Pulse calculator focused on the 10 key metrics
- Minimal, modern UI with clear inputs, calculation buttons, quick recommendations
- Responsive, accessible, and less wordy

How to use:
- Place index.html, sw.js, manifest.json at your site root on HTTPS.
- Provide icons at /icons/icon-192.png and /icons/icon-512.png or adjust manifest paths.

-->

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Profit Pulse — Business Metric Calculator</title>
  <meta name="description" content="Profit Pulse — quick, offline-ready Profit & KPI calculator for small chains. Day/night themes, interactive tips, PWA installable.">
  <meta name="keywords" content="profit calculator, KPI, PWA, offline app, business metrics, franchise metrics, working capital">
  <meta name="author" content="Profit Pulse">
  <meta property="og:title" content="Profit Pulse — KPI calculator" />
  <meta property="og:description" content="Track and calculate the 10 key metrics to know if it's safe to scale. Offline PWA with day/night themes." />

  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"WebApplication",
    "name":"Profit Pulse",
    "url":"/",
    "description":"A compact Profit & KPI calculator for small business owners preparing to scale.",
    "applicationCategory":"BusinessApplication"
  }
  </script>

  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0b1220" id="themeColorMeta">

  <style>
    :root{
      --bg:#f4f7fb; --card:#fff; --text:#041025; --muted:#596374; --accent:#0ea5a4; --accent2:#7c3aed; --good:#10b981; --warn:#f59e0b; --bad:#ef4444;
    }
    [data-theme='dark']{ --bg:#071021; --card:#071826; --text:#e6f0fb; --muted:#9fb0c7; --accent:#34d399; --accent2:#7c3aed; }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;background:linear-gradient(180deg,var(--bg),var(--bg));color:var(--text)}
    .wrap{max-width:1000px;margin:20px auto;padding:18px}
    header{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:52px;height:52px;border-radius:12px;background:linear-gradient(135deg,var(--accent2),var(--accent));display:flex;align-items:center;justify-content:center;color:white;font-weight:800}
    h1{margin:0;font-size:20px}
    p.lead{margin:0;color:var(--muted);font-size:13px}

    .controls{display:flex;gap:8px;align-items:center}
    select,input,button{font:inherit}
    button{background:var(--accent2);border:0;color:white;padding:8px 12px;border-radius:10px;cursor:pointer}
    .ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,0.06)}

    main{display:grid;grid-template-columns:1fr 340px;gap:16px;margin-top:16px}
    @media(max-width:980px){main{grid-template-columns:1fr}}

    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 8px 24px rgba(9,16,32,0.04)}
    .metric-row{display:flex;gap:10px;align-items:center;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.03);margin-bottom:8px}
    .metric-row small{display:block;color:var(--muted);font-size:12px}
    .metric-row .left{flex:1}
    .metric-row input[type='number'], .metric-row input[type='text'], .metric-row select{padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);min-width:120px}

    .kpi-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
    @media(max-width:600px){.kpi-grid{grid-template-columns:1fr}}

    .badge{display:inline-block;padding:6px 8px;border-radius:999px;background:var(--accent);color:white;font-weight:700}
    .score{font-size:32px;font-weight:900}
    .muted{color:var(--muted)}
    footer{margin-top:16px;color:var(--muted);font-size:12px;text-align:center}

    .tiny{font-size:12px}
  </style>
</head>
<body>
  <div class="wrap" id="app">
    <header>
      <div class="brand">
        <div class="logo">PP</div>
        <div>
          <h1>Profit Pulse</h1>
          <p class="lead">Fast profit & readiness calculator for smarter scaling.</p>
        </div>
      </div>

      <div class="controls">
        <label class="tiny muted">Theme</label>
        <select id="themeSelect" aria-label="theme select"><option value="day">Day</option><option value="dark">Night</option></select>
        <button id="installBtn" class="ghost" style="display:none">Install</button>
        <button id="exportBtn" title="Export data">Export</button>
      </div>
    </header>

    <main>
      <section>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <strong>Pulse Dashboard</strong>
              <div class="tiny muted">Fill inputs, tap calculate for instant guidance.</div>
            </div>
            <div style="text-align:right">
              <div class="tiny muted">Pulse Score</div>
              <div id="pulseScore" class="score">—</div>
            </div>
          </div>

          <div style="margin-top:12px">
            <!-- Selling Price -->
            <div class="metric-row">
              <div class="left">
                <strong>Selling price</strong>
                <small>Enter cost and selling price, or use multiplier</small>
              </div>
              <div style="display:flex;flex-direction:column;gap:6px">
                <div style="display:flex;gap:6px">
                  <input type="number" id="costPrice" placeholder="Cost" min="0" step="0.01">
                  <input type="number" id="sellPrice" placeholder="Sell" min="0" step="0.01">
                </div>
                <div style="display:flex;gap:6px">
                  <button id="calcSellBtn">Calc Ratio</button>
                  <input id="sellRatio" type="text" placeholder="Ratio" readonly style="min-width:100px">
                </div>
              </div>
            </div>

            <!-- Rent -->
            <div class="metric-row">
              <div class="left">
                <strong>Rent</strong>
                <small>Monthly rent and monthly revenue</small>
              </div>
              <div style="display:flex;flex-direction:column;gap:6px">
                <div style="display:flex;gap:6px">
                  <input type="number" id="rentAmt" placeholder="Rent" min="0" step="0.01">
                  <input type="number" id="revenueAmt" placeholder="Revenue" min="0" step="0.01">
                </div>
                <div style="display:flex;gap:6px">
                  <button id="calcRentBtn">Calc Rent %</button>
                  <input id="rentPct" type="text" placeholder="% of rev" readonly style="min-width:100px">
                </div>
              </div>
            </div>

            <!-- Productivity per employee -->
            <div class="metric-row">
              <div class="left">
                <strong>Productivity per employee</strong>
                <small>Enter revenue per employee and avg salary</small>
              </div>
              <div style="display:flex;flex-direction:column;gap:6px">
                <div style="display:flex;gap:6px">
                  <input type="number" id="revPerEmp" placeholder="Revenue/emp" min="0" step="0.01">
                  <input type="number" id="avgSalary" placeholder="Avg salary" min="0" step="0.01">
                </div>
                <div style="display:flex;gap:6px">
                  <button id="calcProdBtn">Calc ×Salary</button>
                  <input id="prodRatio" type="text" placeholder="x salary" readonly style="min-width:100px">
                </div>
              </div>
            </div>

            <!-- Salary-to-revenue -->
            <div class="metric-row">
              <div class="left">
                <strong>Salary to revenue</strong>
                <small>Enter total salary cost and revenue</small>
              </div>
              <div style="display:flex;gap:6px;align-items:center">
                <input type="number" id="salaryTotal" placeholder="Total salary" min="0" step="0.01">
                <input type="number" id="revenueTotal" placeholder="Revenue" min="0" step="0.01">
                <button id="calcSalaryBtn">Calc %</button>
                <input id="salaryPct" type="text" placeholder="%" readonly style="min-width:80px">
              </div>
            </div>

            <!-- Customer return rate -->
            <div class="metric-row">
              <div class="left">
                <strong>Customer return rate</strong>
                <small>Enter returning customers and total customers</small>
              </div>
              <div style="display:flex;gap:6px;align-items:center">
                <input type="number" id="returningCust" placeholder="Returning" min="0" step="1">
                <input type="number" id="totalCust" placeholder="Total" min="0" step="1">
                <button id="calcReturnBtn">Calc %</button>
                <input id="returnRate" type="text" placeholder="%" readonly style="min-width:80px">
              </div>
            </div>

            <!-- Marketing ROI -->
            <div class="metric-row">
              <div class="left">
                <strong>Marketing ROI</strong>
                <small>Enter revenue from campaign and campaign cost</small>
              </div>
              <div style="display:flex;gap:6px;align-items:center">
                <input type="number" id="mktRevenue" placeholder="Revenue" min="0" step="0.01">
                <input type="number" id="mktCost" placeholder="Cost" min="0" step="0.01">
                <button id="calcMktBtn">Calc ROI</button>
                <input id="mktROI" type="text" placeholder="x" readonly style="min-width:80px">
              </div>
            </div>

            <!-- Working capital -->
            <div class="metric-row">
              <div class="left">
                <strong>Working capital</strong>
                <small>Enter cash reserve and monthly fixed expenses</small>
              </div>
              <div style="display:flex;gap:6px;align-items:center">
                <input type="number" id="cashReserve" placeholder="Cash" min="0" step="0.01">
                <input type="number" id="fixedExpenses" placeholder="Monthly fixed" min="0" step="0.01">
                <button id="calcWCBtn">Calc months</button>
                <input id="wcMonths" type="text" placeholder="months" readonly style="min-width:80px">
              </div>
            </div>

            <!-- Payback period -->
            <div class="metric-row">
              <div class="left">
                <strong>Payback period</strong>
                <small>Enter investment and monthly net cash</small>
              </div>
              <div style="display:flex;gap:6px;align-items:center">
                <input type="number" id="investment" placeholder="Investment" min="0" step="0.01">
                <input type="number" id="monthlyNet" placeholder="Net/month" min="0" step="0.01">
                <button id="calcPBBtn">Calc months</button>
                <input id="paybackMonths" type="text" placeholder="months" readonly style="min-width:80px">
              </div>
            </div>

            <!-- Operational processes: SOPs, benchmarks, training -->
            <div class="metric-row">
              <div class="left">
                <strong>Operational readiness</strong>
                <small>SOPs (yes/no), Benchmarks (target), Training schedule</small>
              </div>
              <div style="display:flex;flex-direction:column;gap:6px;min-width:220px">
                <div style="display:flex;gap:6px">
                  <select id="sopStatus"><option value="0">No SOP</option><option value="1">SOP exists</option></select>
                  <input id="benchTarget" placeholder="Benchmark (score)" type="number" min="0">
                </div>
                <div style="display:flex;gap:6px">
                  <input id="trainingDate" type="date">
                  <button id="calcOpBtn">Calc Readiness</button>
                  <input id="opScore" type="text" placeholder="score" readonly style="min-width:80px">
                </div>
              </div>
            </div>

            <!-- Profit/Loss cadence (simplified) -->
            <div class="metric-row">
              <div class="left">
                <strong>Profit / Loss</strong>
                <small>Enter revenue and total costs to calculate margin</small>
              </div>
              <div style="display:flex;gap:6px;align-items:center">
                <input type="number" id="revPL" placeholder="Revenue" min="0" step="0.01">
                <input type="number" id="costPL" placeholder="Total cost" min="0" step="0.01">
                <button id="calcPLBtn">Calc margin</button>
                <input id="plMargin" type="text" placeholder="%" readonly style="min-width:80px">
              </div>
            </div>

            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="calcAllBtn">Calculate All</button>
              <button class="ghost" id="saveBtn">Save</button>
              <button class="ghost" id="resetBtn">Reset</button>
            </div>

            <div id="tips" style="margin-top:12px;color:var(--muted)"></div>

          </div>
        </div>
      </section>

      <aside>
        <div class="card">
          <strong>Quick Snapshot</strong>
          <div class="tiny muted">Health at a glance</div>
          <div style="margin-top:10px" id="snapshot"></div>
          <div style="margin-top:14px">
            <strong>Actions</strong>
            <div class="tiny muted">Simple next steps based on Pulse</div>
            <div id="actions" style="margin-top:8px;color:var(--muted)">—</div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <strong>Branches</strong>
          <div class="tiny muted">Manage branches (local only)</div>
          <div style="margin-top:8px"><input id="branchName" placeholder="Branch name"><button class="ghost" id="addBranchBtn">Add</button></div>
          <div id="branches" style="margin-top:8px"></div>
        </div>

      </aside>
    </main>

    <footer>Profit Pulse · PWA · Offline-ready · Minimal & modern</footer>
  </div>

  <script>
    // state
    const LS = 'profitpulse.v1';
    let state = {branches:[],settings:{theme:'day'}};

    // helpers
    const q = s=>document.querySelector(s);
    const num = v=>Number(v)||0;

    function safeAddListener(selector, event, handler){
      const el = q(selector);
      if(el) el.addEventListener(event, handler);
    }

    function loadState(){
      try{
        const raw=localStorage.getItem(LS);
        if(!raw) return; 
        const parsed = JSON.parse(raw);
        // support both older format (state only) and new format {state, inputs}
        if(parsed && parsed.state) state = parsed.state;
        else if(parsed && parsed.branches) state = parsed;
      }catch(e){ state={branches:[],settings:{theme:'day'}} }
    }

    function saveState(){ localStorage.setItem(LS, JSON.stringify({state})); }

    // calc functions
    function calcSellRatio(){
      const cost=num(q('#costPrice')?.value); const sell=num(q('#sellPrice')?.value);
      const r = cost>0? (sell/cost).toFixed(2) : '';
      const el = q('#sellRatio'); if(el) el.value = r; return Number(r)||0;
    }

    function calcRentPct(){
      const rent=num(q('#rentAmt')?.value); const rev=num(q('#revenueAmt')?.value);
      const pct = rev>0? ((rent/rev)*100).toFixed(1) : '';
      const el = q('#rentPct'); if(el) el.value = pct? pct+'%' : ''; return Number(pct)||0;
    }

    function calcProdEmp(){
      const revEmp=num(q('#revPerEmp')?.value); const sal=num(q('#avgSalary')?.value);
      const x = sal>0? (revEmp/sal).toFixed(2) : '';
      const el = q('#prodRatio'); if(el) el.value = x; return Number(x)||0;
    }

    function calcSalaryPct(){
      const sal=num(q('#salaryTotal')?.value); const rev=num(q('#revenueTotal')?.value);
      const pct = rev>0? ((sal/rev)*100).toFixed(1) : '';
      const el = q('#salaryPct'); if(el) el.value = pct? pct+'%' : ''; return Number(pct)||0;
    }

    function calcReturnRate(){
      const ret=num(q('#returningCust')?.value); const tot=num(q('#totalCust')?.value);
      const pct = tot>0? ((ret/tot)*100).toFixed(1) : '';
      const el = q('#returnRate'); if(el) el.value = pct? pct+'%' : ''; return Number(pct)||0;
    }

    function calcMktROI(){
      const rev=num(q('#mktRevenue')?.value); const cost=num(q('#mktCost')?.value);
      const roi = cost>0? (rev/cost).toFixed(2) : '';
      const el = q('#mktROI'); if(el) el.value = roi; return Number(roi)||0;
    }

    function calcWorkingCap(){
      const cash=num(q('#cashReserve')?.value); const fixed=num(q('#fixedExpenses')?.value);
      const months = fixed>0? (cash/fixed).toFixed(1) : '';
      const el = q('#wcMonths'); if(el) el.value = months; return Number(months)||0;
    }

    function calcPayback(){
      const invest=num(q('#investment')?.value); const net=num(q('#monthlyNet')?.value);
      const months = net>0? (invest/net).toFixed(1) : '';
      const el = q('#paybackMonths'); if(el) el.value = months; return Number(months)||0;
    }

    function calcOperational(){
      const sop = Number(q('#sopStatus')?.value||0); const bench = num(q('#benchTarget')?.value);
      const benchNorm = Math.max(0,Math.min(100,bench));
      const score = Math.round((sop*40) + (benchNorm*0.6));
      const el = q('#opScore'); if(el) el.value = score; return Number(score)||0;
    }

    function calcPL(){
      const rev=num(q('#revPL')?.value); const cost=num(q('#costPL')?.value);
      const margin = rev>0? (((rev-cost)/rev)*100).toFixed(1) : '';
      const el = q('#plMargin'); if(el) el.value = margin? margin+'%' : ''; return Number(margin)||0;
    }

    function showSnapshot(a){
      const s = a || {
        sellRatio:q('#sellRatio')?.value, rentPct:q('#rentPct')?.value, prodEmp:q('#prodRatio')?.value,
        salaryPct:q('#salaryPct')?.value, returnRate:q('#returnRate')?.value, mktROI:q('#mktROI')?.value,
        wcMonths:q('#wcMonths')?.value, payback:q('#paybackMonths')?.value, opScore:q('#opScore')?.value, plMargin:q('#plMargin')?.value
      };
      const html = `
        <div class="kpi-grid">
          <div><strong>Sell x</strong><div class="muted">${s.sellRatio||'—'}</div></div>
          <div><strong>Rent %</strong><div class="muted">${s.rentPct||'—'}</div></div>
          <div><strong>Productivity x</strong><div class="muted">${s.prodEmp||'—'}</div></div>
          <div><strong>Salary %</strong><div class="muted">${s.salaryPct||'—'}</div></div>
          <div><strong>Return %</strong><div class="muted">${s.returnRate||'—'}</div></div>
          <div><strong>Mkt ROI</strong><div class="muted">${s.mktROI||'—'}</div></div>
          <div><strong>WC (mo)</strong><div class="muted">${s.wcMonths||'—'}</div></div>
          <div><strong>Payback</strong><div class="muted">${s.payback||'—'}</div></div>
          <div><strong>OpScore</strong><div class="muted">${s.opScore||'—'}</div></div>
          <div><strong>Margin</strong><div class="muted">${s.plMargin||'—'}</div></div>
        </div>
      `;
      const snap = q('#snapshot'); if(snap) snap.innerHTML = html;
    }

    // compute composite pulse score and simple actions
    function computePulse(a){
      const w = {sell:12,rent:10,prod:12,salary:10,ret:10,mkt:8,wc:10,pb:8,op:10,pl:10};
      let total=0, weightSum=0;

      if(a.sellRatio){ total += Math.min(a.sellRatio/2.5,1)*w.sell; weightSum+=w.sell; }
      if(a.rentPct){ total += (a.rentPct<=15?1: Math.max(0,15/a.rentPct))*w.rent; weightSum+=w.rent; }
      if(a.prodEmp){ total += Math.min(a.prodEmp/4,1)*w.prod; weightSum+=w.prod; }
      if(a.salaryPct){ total += (a.salaryPct>=20 && a.salaryPct<=30?1: Math.max(0,30/Math.max(1,a.salaryPct)))*w.salary; weightSum+=w.salary; }
      if(a.returnRate){ total += (a.returnRate>=60?1: a.returnRate/60)*w.ret; weightSum+=w.ret; }
      if(a.mktROI){ total += Math.min(a.mktROI/6,1)*w.mkt; weightSum+=w.mkt; }
      if(a.wcMonths){ total += (a.wcMonths>=3?1: a.wcMonths/3)*w.wc; weightSum+=w.wc; }
      if(a.payback){ total += (a.payback<=18?1: Math.max(0,18/a.payback))*w.pb; weightSum+=w.pb; }
      if(a.opScore){ total += (a.opScore/100)*w.op; weightSum+=w.op; }
      if(a.plMargin){ total += (a.plMargin>=10?1: Math.max(0,a.plMargin/10))*w.pl; weightSum+=w.pl; }

      const percent = weightSum? Math.round((total/weightSum)*100):0;
      const badge = q('#pulseScore'); if(badge) badge.textContent = percent + '%';

      const actions = [];
      if(percent>=80) actions.push('Ready to scale — fundamentals strong.');
      if(percent>=60 && percent<80) actions.push('Caution: optimize rent, pricing or productivity before expanding.');
      if(percent<60) actions.push('Hold expansion. Improve SOPs, working capital, and marketing ROI.');
      const actEl = q('#actions'); if(actEl) actEl.textContent = actions.join(' ');
    }

    // save simple inputs to localStorage for restoration
    function saveStateLocalInputs(){
      const inputs = {
        costPrice:q('#costPrice')?.value, sellPrice:q('#sellPrice')?.value, rentAmt:q('#rentAmt')?.value, revenueAmt:q('#revenueAmt')?.value,
        revPerEmp:q('#revPerEmp')?.value, avgSalary:q('#avgSalary')?.value, salaryTotal:q('#salaryTotal')?.value, revenueTotal:q('#revenueTotal')?.value,
        returningCust:q('#returningCust')?.value, totalCust:q('#totalCust')?.value, mktRevenue:q('#mktRevenue')?.value, mktCost:q('#mktCost')?.value,
        cashReserve:q('#cashReserve')?.value, fixedExpenses:q('#fixedExpenses')?.value, investment:q('#investment')?.value, monthlyNet:q('#monthlyNet')?.value,
        sopStatus:q('#sopStatus')?.value, benchTarget:q('#benchTarget')?.value, trainingDate:q('#trainingDate')?.value,
        revPL:q('#revPL')?.value, costPL:q('#costPL')?.value
      };
      localStorage.setItem(LS, JSON.stringify({state, inputs}));
    }

    function restoreInputs(){
      const raw = localStorage.getItem(LS); if(!raw) return;
      try{
        const parsed = JSON.parse(raw);
        if(parsed.inputs){ Object.keys(parsed.inputs).forEach(k=>{ const el = q('#'+k); if(el) el.value = parsed.inputs[k]; }); }
        if(parsed.state) state = parsed.state;
      }catch(e){ console.warn('restore failed', e); }
    }

    function resetAll(){ if(confirm('Reset all inputs?')){ document.querySelectorAll('input[type="number"], input[type="text"]').forEach(i=>i.value=''); document.querySelectorAll('input[readonly]').forEach(i=>i.value=''); document.querySelectorAll('select').forEach(s=>s.selectedIndex=0); const badge = q('#pulseScore'); if(badge) badge.textContent='—'; const act = q('#actions'); if(act) act.textContent='—'; const snap = q('#snapshot'); if(snap) snap.innerHTML=''; localStorage.removeItem(LS); state={branches:[],settings:{theme:'day'}}; saveState(); renderBranches(); applyTheme(); }}

    // branches
    function renderBranches(){ const el=q('#branches'); if(!el) return; el.innerHTML=''; state.branches.forEach(b=>{ const d=document.createElement('div'); d.className='tiny chip'; d.style.marginBottom='6px'; d.textContent=b.name; el.appendChild(d); }); }

    // theme
    function applyTheme(){ const t = state.settings.theme||'day'; document.documentElement.setAttribute('data-theme', t==='dark'?'dark':'day'); const sel = q('#themeSelect'); if(sel) sel.value = t==='dark'?'dark':'day'; const meta = q('#themeColorMeta'); if(meta) meta.setAttribute('content', t==='dark'?'#071021':'#f4f7fb'); }

    // DOM ready
    document.addEventListener('DOMContentLoaded', ()=>{
      // restore initial state
      loadState(); restoreInputs(); applyTheme(); renderBranches();

      // safe event binding
      safeAddListener('#calcSellBtn','click', calcSellRatio);
      safeAddListener('#calcRentBtn','click', calcRentPct);
      safeAddListener('#calcProdBtn','click', calcProdEmp);
      safeAddListener('#calcSalaryBtn','click', calcSalaryPct);
      safeAddListener('#calcReturnBtn','click', calcReturnRate);
      safeAddListener('#calcMktBtn','click', calcMktROI);
      safeAddListener('#calcWCBtn','click', calcWorkingCap);
      safeAddListener('#calcPBBtn','click', calcPayback);
      safeAddListener('#calcOpBtn','click', calcOperational);
      safeAddListener('#calcPLBtn','click', calcPL);

      safeAddListener('#calcAllBtn','click', ()=>{ const a = {}; a.sellRatio = calcSellRatio(); a.rentPct = calcRentPct(); a.prodEmp = calcProdEmp(); a.salaryPct = calcSalaryPct(); a.returnRate = calcReturnRate(); a.mktROI = calcMktROI(); a.wcMonths = calcWorkingCap(); a.payback = calcPayback(); a.opScore = calcOperational(); a.plMargin = calcPL(); showSnapshot(a); computePulse(a); saveStateLocalInputs(); });

      safeAddListener('#saveBtn','click', saveStateLocalInputs);
      safeAddListener('#resetBtn','click', resetAll);

      // branches
      const addBranch = ()=>{ const input = q('#branchName'); if(!input) return; const n = input.value.trim(); if(!n) return; state.branches.push({id:Date.now(),name:n}); saveState(); renderBranches(); input.value=''; };
      safeAddListener('#addBranchBtn','click', addBranch);

      // theme select
      const themeSel = q('#themeSelect'); if(themeSel) themeSel.addEventListener('change', (e)=>{ state.settings.theme = e.target.value==='dark'?'dark':'day'; saveState(); applyTheme(); });

      // export
      const exportBtn = q('#exportBtn'); if(exportBtn) exportBtn.addEventListener('click', ()=>{ const data = localStorage.getItem(LS)||'{}'; const blob = new Blob([data],{type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='profit-pulse-data.json'; a.click(); URL.revokeObjectURL(url); });

      // install prompt
      let deferredPrompt;
      window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt = e; const ib = q('#installBtn'); if(ib){ ib.style.display='inline-block'; ib.addEventListener('click', async ()=>{ deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; ib.style.display='none'; }); } });

      // service worker
      if('serviceWorker' in navigator){ navigator.serviceWorker.register('/sw.js').catch(()=>console.log('sw fail')); }

    });

    // small keyboard accessibility
    document.body.addEventListener('keydown', (e)=>{ if(e.key==='Enter') { /* optional */ } });
  </script>
</body>
</html>


/* ============================ sw.js ============================ */

// copy below into sw.js at root
self.addEventListener('install', function(event) {
  event.waitUntil(
    caches.open('profitpulse-cache-v1').then(function(cache) {
      return cache.addAll([
        '/',
        '/index.html',
        '/manifest.json'
      ]);
    })
  );
  self.skipWaiting();
});

self.addEventListener('activate', function(event) {
  event.waitUntil(self.clients.claim());
});

self.addEventListener('fetch', function(event) {
  event.respondWith(
    caches.match(event.request).then(function(response) {
      return response || fetch(event.request).catch(()=>caches.match('/index.html'));
    })
  );
});


/* ============================ manifest.json ============================ */

{
  "name": "Profit Pulse",
  "short_name": "ProfitPulse",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#f4f7fb",
  "theme_color": "#0b1220",
  "icons": [
    {"src":"/icons/icon-192.png","sizes":"192x192","type":"image/png"},
    {"src":"/icons/icon-512.png","sizes":"512x512","type":"image/png"}
  ]
}


<!-- End of document -->
